<?xml version="1.0"?>
<configuration xmlns:patch="http://www.sitecore.net/xmlconfig/">
  <sitecore>
    <pipelines>
      <httpRequestBegin>
        <!-- Callback for OAUTH2, logs in a virtual user on successful handshake -->
        <processor type="HMPPS.Authentication.Pipelines.OAuth2SignInCallback, HMPPS.Authentication" resolve="true"
                   patch:before="processor[@type='Sitecore.Pipelines.HttpRequest.UserResolver, Sitecore.Kernel']" >
          <param type="HMPPS.Utilities.Services.UserDataService, HMPPS.Utilities" />
        </processor>

        <!-- The logout redirector handles any logout action needed -->
        <processor type="HMPPS.Authentication.Pipelines.LogoutRedirector, HMPPS.Authentication" resolve="true"
                   patch:after="*[@type='Sitecore.Pipelines.HttpRequest.UserResolver, Sitecore.Kernel']" >
          <param type="HMPPS.Utilities.Services.UserDataService, HMPPS.Utilities" />
        </processor>

        <!-- The Authentication checker check if user/visitor is authenticated both by the identity provider and by Sitecore-->
        <processor type="HMPPS.Authentication.Pipelines.AuthenticationChecker, HMPPS.Authentication" resolve="true"
                   patch:after="*[@type='HMPPS.Authentication.Pipelines.LogoutRedirector, HMPPS.Authentication']" >
          <param type="HMPPS.Utilities.Services.UserDataService, HMPPS.Utilities" />
        </processor>

        <!-- The login redirector redirects the unauthenticated user/visitor to the login page on the identity provider -->
        <processor type="HMPPS.Authentication.Pipelines.LoginRedirector, HMPPS.Authentication"
                   patch:after="*[@type='Sitecore.Pipelines.HttpRequest.LayoutResolver, Sitecore.Kernel']" />

      </httpRequestBegin>
    </pipelines>

    <settings>
      <!-- The URL that the identity provider posts the token back to, absolute URL -->
      <setting name="HMPPS.Authentication.SignInCallbackUrl" value="https://hmpps-cms.localhost/auth-callback" />
      <!-- The URL that handles log out -->
      <setting name="HMPPS.Authentication.LogoutUrl" value="https://hmpps-cms.localhost/logout" />
      <!-- The temp cookie of IDAM login process-->
      <setting name="HMPPS.Authentication.TempCookieName" value="TempCookie" />
      <!-- The OAUTH2 client ID -->
      <setting name="HMPPS.Authentication.ClientId" value="CMS_E3_CLIENTID" />
      <!-- The OAUTH2 client secret -->
      <setting name="HMPPS.Authentication.ClientSecret" value="KainosCMSE3" />
      <!-- The OAUTH2 claims to request -->
      <setting name="HMPPS.Authentication.Scope" value="openid profile email" />
      <!-- The OAUTH2 issuer (base URL) -->
      <setting name="HMPPS.Authentication.ValidIssuer" value="https://51.141.55.159:8080/openam/oauth2" />
      <!-- The OAUTH2 authorize endpoint -->
      <setting name="HMPPS.Authentication.AuthorizeEndpoint" value="https://51.141.55.159:8080/openam/oauth2/authorize" />
      <!-- The OAUTH2 token endpoint -->
      <setting name="HMPPS.Authentication.TokenEndpoint" value="https://51.141.55.159:8080/openam/oauth2/access_token" />
      <!-- The OAUTH2 logout endpoint -->
      <setting name="HMPPS.Authentication.LogoutEndpoint" value="https://51.141.55.159:8080/openam/XUI/#logout/" />
    </settings>
  </sitecore>
</configuration>
